# Kiwi Analyzer - Elasticsearch Analysis Plugin

## Project Overview

Korean morphological analysis plugin for Elasticsearch using [Kiwi](https://github.com/bab2min/Kiwi) library. Written in Kotlin, targeting Elasticsearch 8.12+ stable plugin API.

## Quick Commands

```bash
# Setup (downloads KiwiJava + model)
make setup

# Run tests
make test

# Build plugin
make build

# Clean
make clean
```

## Project Structure

```
kiwi-analyzer/
├── build.gradle.kts         # Gradle build config (Kotlin DSL)
├── Makefile                  # Setup automation (downloads KiwiJava + model)
├── libs/                     # KiwiJava platform-specific JARs
├── kiwi/                     # Kiwi model files (downloaded by make setup)
└── src/
    ├── main/kotlin/.../kiwi/
    │   ├── KiwiTokenizer.kt           # Lucene Tokenizer implementation
    │   ├── KiwiTokenizerFactory.kt    # @NamedComponent("kiwi") tokenizer factory
    │   ├── KiwiTokenizerSettings.kt   # Settings interfaces (@AnalysisSettings)
    │   ├── KiwiAnalyzer.kt            # Lucene Analyzer
    │   ├── KiwiAnalyzerFactory.kt     # @NamedComponent("kiwi") analyzer factory
    │   ├── KiwiPartOfSpeechFilter.kt  # POS tag token filter
    │   ├── KiwiPartOfSpeechFilterFactory.kt
    │   ├── KiwiInstanceManager.kt     # Singleton Kiwi instance manager
    │   ├── NativeLibraryLoader.kt     # JNI native library loading
    │   ├── POSTagSet.kt               # Korean POS tag constants
    │   └── KiwiAnalysisPlugin.kt      # Plugin documentation class
    └── test/kotlin/.../kiwi/
        ├── KiwiTokenizerIntegrationTest.kt
        ├── KiwiAnalyzerIntegrationTest.kt
        ├── KiwiLoadingTest.kt
        ├── POSTagSetTest.kt
        └── KiwiTokenizerSettingsTest.kt
```

## Key Components

### Tokenizer (`type: "kiwi"`)
- `KiwiTokenizer.kt` - Core implementation that converts Kiwi tokens to Lucene tokens
- `KiwiTokenizerFactory.kt` - ES factory with `@NamedComponent("kiwi")`
- `KiwiTokenizerSettings.kt` - Settings: `model_path`, `num_threads`, `discard_punctuation`, `user_dictionary`, `pos_tags_to_include`

### Token Filter (`type: "kiwi_part_of_speech"`)
- `KiwiPartOfSpeechFilter.kt` - Filters tokens by POS tag
- `KiwiPartOfSpeechFilterFactory.kt` - ES factory with `@NamedComponent("kiwi_part_of_speech")`

### Analyzer (`type: "kiwi"`)
- `KiwiAnalyzer.kt` - Complete analyzer combining tokenizer + POS filter + lowercase
- `KiwiAnalyzerFactory.kt` - ES factory

### Infrastructure
- `KiwiInstanceManager.kt` - Manages Kiwi instances (singleton per config)
- `NativeLibraryLoader.kt` - Handles JNI native library loading from JAR
- `POSTagSet.kt` - Korean POS tag constants (NNG, NNP, VV, etc.)

## Configuration Options

### Tokenizer Settings
| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| `model_path` | string | `"kiwi"` | Kiwi model directory path |
| `num_threads` | int | `0` | Worker threads (0=auto) |
| `discard_punctuation` | bool | `true` | Remove punctuation |
| `user_dictionary` | string | `""` | User dictionary file path |
| `pos_tags_to_include` | list | `[]` | POS tags to include (empty=all) |

### POS Filter Settings
| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| `stop_tags` | list | `[]` | POS tags to filter out |

## Testing

Tests require:
1. KiwiJava JAR in `libs/`
2. Kiwi model in `kiwi/`
3. Environment variable `KIWI_MODEL_PATH` pointing to model files

```bash
# Automated (handles setup + env var)
make test

# Manual
KIWI_MODEL_PATH=$(pwd)/kiwi/base ./gradlew test
```

## Build Output

Plugin ZIP: `build/distributions/analysis-kiwi-1.0.0-SNAPSHOT-{platform}.zip`

Platforms: `lnx-x86-64`, `lnx-aarch64`, `mac-arm64`, `win-x64`

## ES Stable Plugin API Notes

- Uses `@NamedComponent` annotations for component registration
- Uses `@AnalysisSettings` interfaces for configuration mapping
- No traditional `plugin-descriptor.properties` source file needed (generated by build)
- Plugin class (`KiwiAnalysisPlugin.kt`) is mainly documentation; components auto-discovered

## Dependencies

- Elasticsearch 8.12.0 plugin API (compileOnly)
- Lucene 9.9.1 (compileOnly)
- KiwiJava (runtime, platform-specific)
- Kotlin 1.9.22
- Java 17
