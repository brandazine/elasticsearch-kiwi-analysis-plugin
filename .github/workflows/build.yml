name: Build

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'LICENSE'
      - '.gitignore'
      - 'docs/**'
  pull_request:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'LICENSE'
      - '.gitignore'
      - 'docs/**'
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  GRADLE_OPTS: '-Dorg.gradle.daemon=false'

jobs:
  test:
    name: Test
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Get latest Kiwi release info
        id: kiwi-release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE_INFO=$(gh api repos/bab2min/Kiwi/releases/latest)
          VERSION=$(echo "$RELEASE_INFO" | jq -r '.tag_name' | sed 's/^v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Kiwi version: $VERSION"

      - name: Cache KiwiJava JAR
        id: cache-kiwi-jar
        uses: actions/cache@v5
        with:
          path: libs
          key: kiwi-jar-mac-arm64-${{ steps.kiwi-release.outputs.version }}

      - name: Download KiwiJava JAR (macOS arm64)
        if: steps.cache-kiwi-jar.outputs.cache-hit != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p libs
          DOWNLOAD_URL=$(gh api repos/bab2min/Kiwi/releases/latest | \
            jq -r '.assets[] | select(.name | contains("kiwi-java") and contains("mac-arm64")) | .browser_download_url')
          echo "Downloading: $DOWNLOAD_URL"
          curl -L -o libs/$(basename "$DOWNLOAD_URL") "$DOWNLOAD_URL"
          ls -la libs/

      - name: Cache Kiwi model
        id: cache-kiwi-model
        uses: actions/cache@v5
        with:
          path: kiwi
          key: kiwi-model-base-${{ steps.kiwi-release.outputs.version }}

      - name: Download Kiwi model
        if: steps.cache-kiwi-model.outputs.cache-hit != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p kiwi
          DOWNLOAD_URL=$(gh api repos/bab2min/Kiwi/releases/latest | \
            jq -r '.assets[] | select(.name | contains("kiwi_model") and contains("base.tgz")) | .browser_download_url')
          echo "Downloading model: $DOWNLOAD_URL"
          curl -L -o /tmp/model.tgz "$DOWNLOAD_URL"
          tar -xzf /tmp/model.tgz -C kiwi

      - name: Update build.gradle.kts version
        run: |
          VERSION=${{ steps.kiwi-release.outputs.version }}
          sed -i '' "s/val kiwiJavaVersion = \"[^\"]*\"/val kiwiJavaVersion = \"$VERSION\"/" build.gradle.kts

      - name: Find model path
        id: model-path
        run: |
          MODEL_PATH=$(find kiwi -name "*.knlm" -o -name "*.morph" 2>/dev/null | head -1 | xargs dirname)
          echo "path=$MODEL_PATH" >> $GITHUB_OUTPUT
          echo "Model path: $MODEL_PATH"

      - name: Run tests
        env:
          KIWI_MODEL_PATH: ${{ steps.model-path.outputs.path }}
        run: ./gradlew test

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results
          path: build/reports/tests/
          retention-days: 7

  build:
    name: Build (${{ matrix.platform }}, ES ${{ matrix.es-version }})
    needs: test
    runs-on: ${{ matrix.runs-on }}
    strategy:
      fail-fast: false
      matrix:
        es-version: ['8.12.0', '9.2.2']
        platform: [lnx-x86-64, lnx-aarch64, mac-arm64, win-x64]
        include:
          - platform: lnx-x86-64
            runs-on: ubuntu-latest
          - platform: lnx-aarch64
            runs-on: ubuntu-latest
          - platform: mac-arm64
            runs-on: macos-latest
          - platform: win-x64
            runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ startsWith(matrix.es-version, '9.') && '21' || '17' }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Get latest Kiwi release info
        id: kiwi-release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE_INFO=$(gh api repos/bab2min/Kiwi/releases/latest)
          VERSION=$(echo "$RELEASE_INFO" | jq -r '.tag_name' | sed 's/^v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Cache KiwiJava JAR
        id: cache-kiwi-jar
        uses: actions/cache@v5
        with:
          path: libs
          key: kiwi-jar-${{ matrix.platform }}-${{ steps.kiwi-release.outputs.version }}

      - name: Download KiwiJava JAR
        if: steps.cache-kiwi-jar.outputs.cache-hit != 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p libs
          DOWNLOAD_URL=$(gh api repos/bab2min/Kiwi/releases/latest | \
            jq -r '.assets[] | select(.name | contains("kiwi-java") and contains("${{ matrix.platform }}")) | .browser_download_url')
          echo "Downloading: $DOWNLOAD_URL"
          curl -L -o libs/$(basename "$DOWNLOAD_URL") "$DOWNLOAD_URL"

      - name: Update build.gradle.kts version (Unix)
        if: runner.os != 'Windows'
        run: |
          VERSION=${{ steps.kiwi-release.outputs.version }}
          sed -i.bak "s/val kiwiJavaVersion = \"[^\"]*\"/val kiwiJavaVersion = \"$VERSION\"/" build.gradle.kts

      - name: Update build.gradle.kts version (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $version = "${{ steps.kiwi-release.outputs.version }}"
          (Get-Content build.gradle.kts) -replace 'val kiwiJavaVersion = "[^"]*"', "val kiwiJavaVersion = `"$version`"" | Set-Content build.gradle.kts

      - name: Build plugin
        env:
          KIWI_PLATFORM: ${{ matrix.platform }}
          ES_VERSION: ${{ matrix.es-version }}
        run: ./gradlew jar bundlePlugin -x test

      - name: List build outputs
        shell: bash
        run: ls -la build/distributions/

      - name: Upload plugin artifact
        uses: actions/upload-artifact@v6
        with:
          name: analysis-kiwi-es${{ matrix.es-version }}-${{ matrix.platform }}
          path: build/distributions/*.zip
          retention-days: 30

  release:
    name: Create Release
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v5
        with:
          path: artifacts
          pattern: analysis-kiwi-es*
          merge-multiple: false

      - name: List artifacts
        run: find artifacts -type f -name "*.zip"

      - name: Generate release tag
        id: tag
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          DATE=$(date +%Y%m%d)
          SHORT_SHA=${GITHUB_SHA::7}

          # Get existing tags for today and find the highest number
          EXISTING_TAGS=$(gh api repos/${{ github.repository }}/tags --jq '.[].name' | grep "^${DATE}-" | sort -r || true)

          if [ -z "$EXISTING_TAGS" ]; then
            NUM="01"
          else
            LAST_NUM=$(echo "$EXISTING_TAGS" | head -1 | sed -E "s/${DATE}-([0-9]+)\..*/\1/")
            NEXT_NUM=$((10#$LAST_NUM + 1))
            NUM=$(printf "%02d" $NEXT_NUM)
          fi

          TAG="${DATE}-${NUM}.${SHORT_SHA}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Generated tag: $TAG"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          generate_release_notes: true
          files: artifacts/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
