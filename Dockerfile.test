# Test Dockerfile for Kiwi Analyzer Plugin
#
# Usage (x86-64):
#   ES_VERSION=8.12.0 KIWI_PLATFORM=lnx-x86-64 ./gradlew bundlePlugin -x test
#   docker build --platform linux/amd64 --build-arg ES_VERSION=8.12.0 --build-arg PLATFORM=lnx-x86-64 -f Dockerfile.test -t kiwi-es8-test .
#   docker run -d --name kiwi-es8 --platform linux/amd64 -e "discovery.type=single-node" -e "xpack.security.enabled=false" -p 9200:9200 kiwi-es8-test
#
# Usage (ARM64 - Apple Silicon):
#   ES_VERSION=9.2.2 KIWI_PLATFORM=lnx-aarch64 ./gradlew bundlePlugin -x test
#   docker build --platform linux/arm64 --build-arg ES_VERSION=9.2.2 --build-arg PLATFORM=lnx-aarch64 -f Dockerfile.test -t kiwi-es9-test .
#   docker run -d --name kiwi-es9 --platform linux/arm64 -e "discovery.type=single-node" -e "xpack.security.enabled=false" -p 9201:9200 kiwi-es9-test

ARG ES_VERSION=8.12.0
FROM docker.elastic.co/elasticsearch/elasticsearch:${ES_VERSION}

ARG ES_VERSION
ARG PLATFORM=lnx-x86-64

# Copy plugin ZIP
COPY build/distributions/analysis-kiwi-*-es${ES_VERSION}-${PLATFORM}.zip /tmp/analysis-kiwi.zip

# Install plugin
RUN elasticsearch-plugin install --batch file:///tmp/analysis-kiwi.zip

# Copy Kiwi model files to config directory
COPY kiwi/models/cong/base/ /usr/share/elasticsearch/config/kiwi/

# Set proper permissions
USER root
RUN chown -R elasticsearch:elasticsearch /usr/share/elasticsearch/config/kiwi
USER elasticsearch
